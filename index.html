<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Israeli Vehicle Lookup - ×—×™×¤×•×© ×¨×›×‘ ×™×©×¨××œ×™</title>
 
  <!-- OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
 
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
 
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0066cc 0%, #0047ab 100%);
      min-height: 100vh;
      padding: 20px;
      direction: rtl;
    }
 
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 24px;
      box-shadow: 0 25px 70px rgba(0,0,0,0.35);
      overflow: hidden;
    }
 
    .header {
      background: linear-gradient(135deg, #0066cc 0%, #0047ab 100%);
      color: white;
      padding: 35px;
      text-align: center;
    }
 
    .header h1 { font-size: 32px; margin-bottom: 12px; font-weight: 700; }
    .header p { opacity: 0.95; font-size: 15px; }
 
    .content { padding: 35px; }
 
    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 25px;
    }
 
    @media (max-width: 768px) {
      .two-column { grid-template-columns: 1fr; }
    }
 
    .column {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 16px;
      border: 2px solid #e0e0e0;
    }
 
    .column h3 {
      color: #0066cc;
      margin-bottom: 18px;
      font-size: 19px;
      font-weight: 700;
    }
 
    .upload-area {
      border: 3px dashed #0066cc;
      border-radius: 12px;
      padding: 35px 25px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
      margin-bottom: 18px;
    }
 
    .upload-area:hover {
      border-color: #0047ab;
      background: #f0f7ff;
      transform: translateY(-2px);
    }
 
    .upload-icon { font-size: 48px; margin-bottom: 12px; }
    input[type="file"] { display: none; }
 
    .image-preview {
      position: relative;
      text-align: center;
      background: white;
      border-radius: 12px;
      padding: 18px;
      border: 2px solid #e0e0e0;
    }
 
    .image-preview img {
      max-width: 100%;
      max-height: 350px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: scale(1);
    }
 
    .remove-image {
      position: absolute;
      top: 24px;
      left: 24px;
      background: rgba(211, 47, 47, 0.95);
      color: white;
      border: none;
      border-radius: 50%;
      width: 34px;
      height: 34px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      transition: all 0.2s;
      z-index: 10;
    }
 
    .remove-image:hover { background: #d32f2f; transform: scale(1.15); }
 
    .zoom-controls {
      margin-top: 12px;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }
 
    .zoom-btn {
      padding: 9px 16px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 700;
      transition: all 0.2s;
      white-space: nowrap;
    }
 
    .zoom-btn:hover { background: #0047ab; transform: translateY(-1px); }
 
    .input-group { margin-bottom: 20px; }
 
    .input-group label {
      display: block;
      margin-bottom: 12px;
      font-weight: 700;
      color: #333;
      font-size: 16px;
    }
 
    .input-group input {
      width: 100%;
      padding: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 22px;
      text-align: center;
      letter-spacing: 4px;
      transition: all 0.3s;
      font-weight: 700;
      background: white;
      direction: ltr;
    }
 
    .input-group input:focus {
      outline: none;
      border-color: #0066cc;
      box-shadow: 0 0 0 4px rgba(0, 102, 204, 0.1);
    }
 
    .format-hint {
      background: #fff3e0;
      padding: 12px;
      border-radius: 10px;
      margin: 12px 0;
      font-size: 14px;
      color: #e65100;
      text-align: center;
      font-weight: 700;
    }
 
    .btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #0066cc 0%, #0047ab 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }
 
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 102, 204, 0.4);
    }
 
    .btn:active { transform: translateY(0); }
 
    .btn.secondary {
      background: #ffffff;
      color: #0047ab;
      border: 2px solid #0047ab;
      box-shadow: none;
    }
 
    .btn.secondary:hover {
      background: #f0f7ff;
      box-shadow: none;
    }
 
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      border: none;
      color: #666;
    }
 
    .loading {
      text-align: center;
      padding: 25px;
      color: #0066cc;
      font-weight: 700;
    }
 
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0066cc;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
 
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
 
    .results {
      margin-top: 30px;
      padding: 28px;
      background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      border-radius: 16px;
      border-right: 5px solid #4caf50;
      animation: slideIn 0.4s;
    }
 
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
 
    .results h3 {
      color: #2e7d32;
      margin-bottom: 22px;
      font-size: 22px;
      font-weight: 700;
    }
 
    .result-item {
      padding: 16px 0;
      border-bottom: 2px solid rgba(255,255,255,0.5);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
 
    .result-item:last-child { border-bottom: none; }
 
    .result-label {
      font-weight: 700;
      color: #1b5e20;
      font-size: 15px;
      white-space: nowrap;
    }
 
    .result-value {
      color: #1b5e20;
      font-weight: 700;
      font-size: 17px;
      text-align: left;
      direction: ltr;
      overflow-wrap: anywhere;
    }
 
    .error {
      padding: 18px;
      background: #ffebee;
      color: #c62828;
      border-radius: 12px;
      margin-top: 18px;
      text-align: center;
      border-right: 5px solid #d32f2f;
      font-weight: 700;
      line-height: 1.4;
    }
 
    .status-message {
      margin-top: 15px;
      padding: 14px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 700;
      text-align: center;
      animation: fadeIn 0.3s;
      line-height: 1.4;
    }
 
    .status-message.processing {
      background: #fff3e0;
      color: #e65100;
      border: 2px solid #ff9800;
    }
 
    .status-message.success {
      background: #e8f5e9;
      color: #2e7d32;
      border: 2px solid #4caf50;
    }
 
    .status-message.info {
      background: #e3f2fd;
      color: #0d47a1;
      border: 2px solid #2196f3;
    }
 
    .status-message.error {
      background: #ffebee;
      color: #c62828;
      border: 2px solid #d32f2f;
    }
 
    .candidate-box {
      margin-top: 14px;
      padding: 14px;
      border-radius: 12px;
      background: #f0f7ff;
      border: 2px solid #bbdefb;
      display: none;
    }
 
    .candidate-title {
      font-weight: 800;
      margin-bottom: 8px;
      color: #0d47a1;
      font-size: 14px;
    }
 
    .candidate-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
 
    .candidate-chip {
      padding: 8px 12px;
      border-radius: 999px;
      background: white;
      border: 2px solid #0d47a1;
      color: #0d47a1;
      font-weight: 800;
      cursor: pointer;
      direction: ltr;
    }
 
    .candidate-chip.active {
      background: #0d47a1;
      color: white;
    }
 
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸš— ×—×™×¤×•×© ×¨×›×‘ ×™×©×¨××œ×™</h1>
      <p>OCR ××•×˜×•××˜×™ + ×—×™×¤×•×© ×“×¨×š Backend</p>
    </div>
 
    <div class="content">
      <div class="two-column">
        <!-- Image Column -->
        <div class="column">
          <h3>ğŸ“¸ ×”×¢×œ×” ×ª××•× ×ª ×œ×•×—×™×ª (OCR ××•×˜×•××˜×™)</h3>
 
          <div id="uploadArea" class="upload-area" onclick="document.getElementById('fileInput').click()">
            <div class="upload-icon">ğŸ“·</div>
            <h4 style="margin-bottom: 8px;">×œ×—×¥ ××• ×’×¨×•×¨ ×ª××•× ×”</h4>
            <p style="font-size: 13px; color: #555;">×œ×”×¦×œ×—×” ××™×˜×‘×™×ª: ×¦×œ×/×—×ª×•×š ×¨×§ ××ª ×œ×•×—×™×ª ×”×¨×™×©×•×™ ××§×¨×•×‘</p>
            <p style="font-size: 14px; color: #666;">× ×–×”×” ××¡×¤×¨ ×•× ×—×¤×©. ×× ×œ× × ××¦× â€” ×ª×•×›×œ ×œ× ×¡×•×ª ××•×¢××“ ×”×‘×.</p>
            <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">
          </div>
 
          <div id="imagePreview" style="display: none;">
            <div class="image-preview">
              <button class="remove-image" onclick="removeImage()">âœ•</button>
              <img id="previewImage" src="" alt="Preview">
            </div>
 
            <div class="zoom-controls">
              <button class="zoom-btn" onclick="zoom('in')">ğŸ” ×”×’×“×œ</button>
              <button class="zoom-btn" onclick="zoom('out')">ğŸ” ×”×§×˜×Ÿ</button>
              <button class="zoom-btn" onclick="zoom('reset')">â†º ××¤×¡</button>
              <button class="zoom-btn" id="btnTryNext" onclick="tryNextCandidate()" disabled>â¡ï¸ × ×¡×” ××•×¢××“ ×”×‘×</button>
            </div>
 
            <div id="candidateBox" class="candidate-box">
              <div class="candidate-title">××•×¢××“×™× ×©×–×•×”×• (×œ×—×¥ ×œ×‘×—×•×¨):</div>
              <div id="candidateList" class="candidate-list"></div>
            </div>
          </div>
 
          <div id="statusMessage"></div>
        </div>
 
        <!-- Input Column -->
        <div class="column">
          <h3>âŒ¨ï¸ ××• ×”×–×Ÿ ××¡×¤×¨ ×™×“× ×™×ª</h3>
 
          <div class="format-hint">ğŸ’¡ ×”×–×Ÿ ×¨×§ ××¡×¤×¨×™× (7-8 ×¡×¤×¨×•×ª)</div>
 
          <div class="input-group">
            <label>××¡×¤×¨ ×œ×•×—×™×ª:</label>
            <input
              type="text"
              id="plateInput"
              placeholder="60570703"
              maxlength="8"
              dir="ltr"
              inputmode="numeric"
            >
          </div>
 
          <button class="btn" onclick="searchVehicle()">
            ğŸ” ×—×¤×© ×‘×××’×¨
          </button>
        </div>
      </div>
 
      <div id="loading" style="display: none;"></div>
      <div id="error" style="display: none;"></div>
      <div id="results" style="display: none;"></div>
    </div>
  </div>
 
  <script>
    let zoomLevel = 1;
    let isOcrRunning = false;
 
    // candidates state
    let ocrCandidates = [];
    let currentCandidateIndex = -1;

    // #region agent log
    function _debugLog(location, message, data, hypothesisId) {
      const payload = { location, message, data: data || {}, timestamp: Date.now(), hypothesisId };
      fetch('http://127.0.0.1:7242/ingest/0a3fcd45-4279-4bcf-a794-aa2ba6df3f6f', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }).catch(function() {});
    }
    // #endregion

    // Server URL
    const SERVER_URL = 'https://israeli-vehicle-lookup.onrender.com';
 
    function normalizePlate(input) {
      if (input === undefined || input === null) return '';
      return String(input).replace(/\D/g, '');
    }
 
    function showStatus(message, type) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.innerHTML = `<div class="status-message ${type}">${message}</div>`;
    }
 
    function clearOutputs() {
      document.getElementById('error').style.display = 'none';
      document.getElementById('results').style.display = 'none';
      document.getElementById('loading').style.display = 'none';
    }
 
    function resetCandidatesUI() {
      ocrCandidates = [];
      currentCandidateIndex = -1;
      document.getElementById('btnTryNext').disabled = true;
      document.getElementById('candidateBox').style.display = 'none';
      document.getElementById('candidateList').innerHTML = '';
    }
 
    function renderCandidates() {
      const box = document.getElementById('candidateBox');
      const list = document.getElementById('candidateList');
 
      if (!ocrCandidates.length) {
        box.style.display = 'none';
        list.innerHTML = '';
        return;
      }
 
      box.style.display = 'block';
      list.innerHTML = '';
 
      ocrCandidates.forEach((c, idx) => {
        const btn = document.createElement('button');
        btn.className = 'candidate-chip' + (idx === currentCandidateIndex ? ' active' : '');
        btn.type = 'button';
        btn.textContent = formatPlateNumber(c);
        btn.onclick = async () => {
          currentCandidateIndex = idx;
          document.getElementById('plateInput').value = ocrCandidates[currentCandidateIndex];
          renderCandidates();
          await searchVehicle(ocrCandidates[currentCandidateIndex]);
        };
        list.appendChild(btn);
      });
    }
 
    function setTryNextEnabled() {
      const btn = document.getElementById('btnTryNext');
      btn.disabled = !(ocrCandidates.length > 1 && currentCandidateIndex < ocrCandidates.length - 1);
    }
 
    // Drag and drop
    const uploadArea = document.getElementById('uploadArea');
 
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = '#0047ab';
      uploadArea.style.background = '#f0f7ff';
    });
 
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.style.borderColor = '#0066cc';
      uploadArea.style.background = 'white';
    });
 
    uploadArea.addEventListener('drop', async (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = '#0066cc';
      uploadArea.style.background = 'white';
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        await processImageAndAutoSearch(files[0]);
      }
    });
 
    async function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        await processImageAndAutoSearch(file);
      }
    }
 
    async function processImageAndAutoSearch(file) {
      if (isOcrRunning) return;
 
      clearOutputs();
      resetCandidatesUI();
      showStatus('×˜×•×¢×Ÿ ×ª××•× ×”...', 'processing');
 
      const reader = new FileReader();
      reader.onload = async (e) => {
        const img = document.getElementById('previewImage');
        img.src = e.target.result;
 
        document.getElementById('imagePreview').style.display = 'block';
        document.getElementById('uploadArea').style.display = 'none';
 
        await new Promise(resolve => { img.onload = resolve; });
 
        await runOcrAndSearch(img);
      };
      reader.readAsDataURL(file);
    }
 
    function extractCandidatesFromText(text) {
      // #region agent log
      _debugLog('index.html:extractCandidatesFromText', 'extractCandidatesFromText entry', { textLength: (text && text.length) || 0, textSnippet: (String(text || '').substring(0, 300)) }, 'H1');
      // #endregion
      // ×œ×•×§×— ××ª ×›×œ ×”×¡×¤×¨×•×ª ××”×˜×§×¡×˜, ××—×œ×¥ ×¨×¦×¤×™× ×©×œ 5-9 ×¡×¤×¨×•×ª (7-8 ×œ×©×œ×™×—×” ×œ-API, 5-6 ×œ×”×©×œ××” ×™×“× ×™×ª)
      const digitsOnly = String(text || '').replace(/\D/g, '');
      const matches = digitsOnly.match(/\d{5,9}/g) || [];
      // #region agent log
      _debugLog('index.html:extractCandidatesFromText', 'after regex', { digitsOnlyLength: digitsOnly.length, digitsOnlySnippet: digitsOnly.substring(0, 100), matchesLength: matches.length, matches: matches.slice(0, 5) }, 'H2');
      // #endregion

      const seen = new Set();
      const unique = [];
      for (const m of matches) {
        let toAdd = [];
        if (m.length === 7 || m.length === 8) toAdd = [m];
        else if (m.length === 9) toAdd = [m.slice(0, 8), m.slice(0, 7)];
        else if (m.length === 5 || m.length === 6) toAdd = [m];
        for (const c of toAdd) {
          if (!seen.has(c)) {
            seen.add(c);
            unique.push(c);
          }
        }
      }

      return unique.slice(0, 8);
    }

    function extractCandidatesFromWords(words, imageHeight) {
      if (!words || !imageHeight) return [];
      const seen = new Set();
      const withScore = [];

      var digitWords = [];
      for (var i = 0; i < words.length; i++) {
        var t = (words[i].text || '').replace(/\D/g, '');
        if (t.length === 0) continue;
        var bbox = words[i].bbox || {};
        var cx = (bbox.x0 != null && bbox.x1 != null) ? (bbox.x0 + bbox.x1) / 2 : 0;
        var cy = (bbox.y0 != null && bbox.y1 != null) ? (bbox.y0 + bbox.y1) / 2 : 0;
        digitWords.push({ text: t, x: cx, y: cy });
      }
      digitWords.sort(function(a, b) { return a.y - b.y || a.x - b.x; });
      var lineTol = Math.max(12, imageHeight * 0.08);
      var lines = [];
      for (i = 0; i < digitWords.length; i++) {
        var dw = digitWords[i];
        var found = false;
        for (var L = 0; L < lines.length; L++) {
          if (Math.abs(lines[L][0].y - dw.y) <= lineTol) { lines[L].push(dw); found = true; break; }
        }
        if (!found) lines.push([dw]);
      }
      for (L = 0; L < lines.length; L++) {
        var row = lines[L].slice();
        row.sort(function(a, b) { return a.x - b.x; });
        var merged = row.map(function(w) { return w.text; }).join('');
        if (merged.length < 5 || merged.length > 9) continue;
        var score = row.reduce(function(s, w) { return s + w.y; }, 0) / row.length / imageHeight;
        if (merged.length === 7 || merged.length === 8) {
          if (!seen.has(merged)) { seen.add(merged); withScore.push({ c: merged, score: score }); }
        } else if (merged.length === 9) {
          if (!seen.has(merged.slice(0, 8))) { seen.add(merged.slice(0, 8)); withScore.push({ c: merged.slice(0, 8), score: score }); }
          if (!seen.has(merged.slice(0, 7))) { seen.add(merged.slice(0, 7)); withScore.push({ c: merged.slice(0, 7), score: score }); }
        } else {
          if (!seen.has(merged)) { seen.add(merged); withScore.push({ c: merged, score: score }); }
        }
      }

      for (i = 0; i < words.length; i++) {
        var w = words[i];
        var text = (w.text || '').replace(/\D/g, '');
        if (text.length < 5 || text.length > 9) continue;
        var bbox = w.bbox || {};
        var centerY = (bbox.y0 != null && bbox.y1 != null) ? (bbox.y0 + bbox.y1) / 2 : 0;
        var score = centerY / imageHeight;
        var toAdd = [];
        if (text.length === 7 || text.length === 8) toAdd = [text];
        else if (text.length === 9) toAdd = [text.slice(0, 8), text.slice(0, 7)];
        else if (text.length === 5 || text.length === 6) toAdd = [text];
        for (var j = 0; j < toAdd.length; j++) {
          var c = toAdd[j];
          if (!seen.has(c)) {
            seen.add(c);
            withScore.push({ c: c, score: score });
          }
        }
      }
      withScore.sort(function(a, b) { return b.score - a.score; });
      var out = [];
      for (i = 0; i < withScore.length; i++) {
        var x = withScore[i].c;
        if (x.length >= 5 && x.length <= 8) out.push(x);
      }
      return out.slice(0, 8);
    }

    function scaleImageForOcr(imgElement, minLongSidePx) {
      minLongSidePx = minLongSidePx || 1200;
      const w = imgElement.naturalWidth || imgElement.width;
      const h = imgElement.naturalHeight || imgElement.height;
      if (!w || !h) return imgElement;
      const long = Math.max(w, h);
      const scale = long < minLongSidePx ? minLongSidePx / long : 1;
      if (scale <= 1) return imgElement;
      const c = document.createElement('canvas');
      c.width = Math.round(w * scale);
      c.height = Math.round(h * scale);
      const ctx = c.getContext('2d');
      ctx.drawImage(imgElement, 0, 0, c.width, c.height);
      return c;
    }

    function cropBottomForPlate(imgElement, fraction) {
      fraction = fraction == null ? 0.5 : fraction;
      const w = imgElement.naturalWidth || imgElement.width;
      const h = imgElement.naturalHeight || imgElement.height;
      if (!w || !h) return null;
      const cropH = Math.max(80, Math.round(h * fraction));
      const c = document.createElement('canvas');
      c.width = w;
      c.height = cropH;
      const ctx = c.getContext('2d');
      ctx.drawImage(imgElement, 0, h - cropH, w, cropH, 0, 0, w, cropH);
      return c;
    }

    function isolateYellowPlateRegion(source) {
      const w = source.width || source.naturalWidth;
      const h = source.height || source.naturalHeight;
      if (!w || !h) return null;
      const c = document.createElement('canvas');
      c.width = w;
      c.height = h;
      const ctx = c.getContext('2d');
      ctx.drawImage(source, 0, 0);
      const imgData = ctx.getImageData(0, 0, w, h);
      const data = imgData.data;
      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        const lum = (r + g + b) / 3;
        const isYellow = (r > 110 && g > 100 && b < 230 && (r + g) > 230);
        const isDark = lum < 130;
        const keep = isYellow && isDark;
        const v = keep ? 0 : 255;
        data[i] = data[i + 1] = data[i + 2] = v;
      }
      ctx.putImageData(imgData, 0, 0);
      return c;
    }

    async function runOcrAndSearch(imgElement) {
      try {
        isOcrRunning = true;
        showStatus('××–×”×” ××¡×¤×¨ ×¨×›×‘ (OCR)...', 'processing');

        const scaled = scaleImageForOcr(imgElement, 2200);
        const cropSrc = scaled instanceof HTMLCanvasElement ? scaled : imgElement;
        const ocrCrop = cropBottomForPlate(cropSrc, 0.35);
        const opts = {
          tessedit_char_whitelist: '0123456789',
          preserve_interword_spaces: '1'
        };

        let candidates = [];
        let rawText = '';

        opts.tessedit_pageseg_mode = '3';
        if (ocrCrop) {
          var fromYellow = [];
          var yellowCrop = isolateYellowPlateRegion(ocrCrop);
          if (yellowCrop) {
            showStatus('××–×”×” ×œ×•×—×™×ª ×¦×”×•×‘×” (×™×©×¨××œ)...', 'processing');
            var resYellow = await Tesseract.recognize(yellowCrop, 'eng', opts);
            var txtYellow = resYellow && resYellow.data && resYellow.data.text ? resYellow.data.text : '';
            fromYellow = extractCandidatesFromWords(resYellow && resYellow.data && resYellow.data.words, yellowCrop.height) || [];
            if (!fromYellow.length) fromYellow = extractCandidatesFromText(txtYellow);
          }
          showStatus('××–×”×” ××¡×¤×¨ ×¨×›×‘ (××–×•×¨ ×œ×•×—×™×ª)...', 'processing');
          var resCrop = await Tesseract.recognize(ocrCrop, 'eng', opts);
          rawText = resCrop && resCrop.data && resCrop.data.text ? resCrop.data.text : '';
          var fromCrop = extractCandidatesFromWords(resCrop && resCrop.data && resCrop.data.words, ocrCrop.height) || [];
          var fromText = extractCandidatesFromText(rawText) || [];
          var seenMerge = {};
          candidates = [];
          fromText.forEach(function(c) { if (!seenMerge[c]) { seenMerge[c] = true; candidates.push(c); } });
          fromCrop.forEach(function(c) { if (!seenMerge[c]) { seenMerge[c] = true; candidates.push(c); } });
          fromYellow.forEach(function(c) { if (!seenMerge[c]) { seenMerge[c] = true; candidates.push(c); } });
          candidates.sort(function(a, b) {
            var want = function(len) { return len === 8 ? 0 : len === 7 ? 1 : len === 6 ? 2 : 3; };
            return want(a.length) - want(b.length);
          });
        }
        if (!candidates.length && scaled) {
          showStatus('×× ×¡×” ×–×™×”×•×™ ×¢×œ ×›×œ ×”×ª××•× ×”...', 'processing');
          var resFull = await Tesseract.recognize(scaled, 'eng', opts);
          rawText = resFull && resFull.data && resFull.data.text ? resFull.data.text : '';
          var h = scaled instanceof HTMLCanvasElement ? scaled.height : (imgElement.naturalHeight || imgElement.height);
          var fromFull = extractCandidatesFromWords(resFull && resFull.data && resFull.data.words, h) || [];
          var fromTextFull = extractCandidatesFromText(rawText) || [];
          candidates = [];
          fromTextFull.forEach(function(c) { candidates.push(c); });
          fromFull.forEach(function(c) { if (candidates.indexOf(c) === -1) candidates.push(c); });
          candidates.sort(function(a, b) { var w = function(l) { return l === 8 ? 0 : l === 7 ? 1 : l === 6 ? 2 : 3; }; return w(a.length) - w(b.length); });
        }
        if (!candidates.length && ocrCrop) {
          opts.tessedit_pageseg_mode = '7';
          var resLine = await Tesseract.recognize(ocrCrop, 'eng', opts);
          rawText = resLine && resLine.data && resLine.data.text ? resLine.data.text : '';
          var fromLine = extractCandidatesFromWords(resLine && resLine.data && resLine.data.words, ocrCrop.height) || [];
          var fromTextLine = extractCandidatesFromText(rawText) || [];
          candidates = [];
          fromTextLine.forEach(function(c) { candidates.push(c); });
          fromLine.forEach(function(c) { if (candidates.indexOf(c) === -1) candidates.push(c); });
          candidates.sort(function(a, b) { var w = function(l) { return l === 8 ? 0 : l === 7 ? 1 : l === 6 ? 2 : 3; }; return w(a.length) - w(b.length); });
        }

        const fullCandidates = candidates.filter(function(c) { return c.length === 7 || c.length === 8; });
        const partialCandidates = candidates.filter(function(c) { return c.length === 5 || c.length === 6; });

        if (fullCandidates.length) {
          ocrCandidates = fullCandidates;
          currentCandidateIndex = 0;
          document.getElementById('plateInput').value = ocrCandidates[currentCandidateIndex];
          renderCandidates();
          setTryNextEnabled();
          showStatus(
            '×–×•×”×• ' + ocrCandidates.length + ' ××•×¢××“×™×. ×× ×¡×”: ' + formatPlateNumber(ocrCandidates[currentCandidateIndex]),
            'success'
          );
          await searchVehicle(ocrCandidates[currentCandidateIndex]);
        } else if (partialCandidates.length) {
          ocrCandidates = [];
          currentCandidateIndex = -1;
          document.getElementById('plateInput').value = partialCandidates[0];
          resetCandidatesUI();
          showStatus('×–×•×”×• ' + partialCandidates[0].length + ' ×¡×¤×¨×•×ª â€“ ×”×©×œ× ×œ-7â€“8 ×¡×¤×¨×•×ª ×•×”×—×¤×©.', 'info');
        } else {
          // #region agent log
          _debugLog('index.html:runOcrAndSearch', 'no candidates - showing error', { finalRawTextLength: rawText.length, finalRawTextSnippet: rawText.substring(0, 400), candidatesLength: candidates.length }, 'H5');
          // #endregion
          showStatus('×œ× ×”×¦×œ×—×ª×™ ×œ×–×”×•×ª ××¡×¤×¨. × ×¡×” ×ª××•× ×” ×—×“×”/×§×¨×•×‘×” ×™×•×ª×¨ ×©×œ ×”×œ×•×—×™×ª ××• ×”×§×œ×“ ×™×“× ×™×ª.', 'error');
          isOcrRunning = false;
          return;
        }
      } catch (err) {
        showStatus(`×©×’×™××ª OCR: ${err?.message || 'unknown error'}`, 'error');
      } finally {
        isOcrRunning = false;
      }
    }
 
    async function tryNextCandidate() {
      if (!ocrCandidates.length) return;
      if (currentCandidateIndex >= ocrCandidates.length - 1) return;
 
      currentCandidateIndex += 1;
      document.getElementById('plateInput').value = ocrCandidates[currentCandidateIndex];
 
      renderCandidates();
      setTryNextEnabled();
 
      showStatus(`×× ×¡×” ××•×¢××“ ×”×‘×: ${formatPlateNumber(ocrCandidates[currentCandidateIndex])}`, 'info');
      await searchVehicle(ocrCandidates[currentCandidateIndex]);
    }
 
    function removeImage() {
      document.getElementById('imagePreview').style.display = 'none';
      document.getElementById('uploadArea').style.display = 'block';
      document.getElementById('fileInput').value = '';
      document.getElementById('statusMessage').innerHTML = '';
      document.getElementById('results').style.display = 'none';
      zoomLevel = 1;
      document.getElementById('previewImage').style.transform = 'scale(1)';
      isOcrRunning = false;
      resetCandidatesUI();
      clearOutputs();
    }
 
    function zoom(action) {
      const img = document.getElementById('previewImage');
      if (action === 'in') {
        zoomLevel = Math.min(zoomLevel + 0.25, 3);
      } else if (action === 'out') {
        zoomLevel = Math.max(zoomLevel - 0.25, 0.5);
      } else if (action === 'reset') {
        zoomLevel = 1;
      }
      img.style.transform = `scale(${zoomLevel})`;
    }
 
    async function searchVehicle(optionalPlate) {
      const plateNumber = normalizePlate(optionalPlate || document.getElementById('plateInput').value);
 
      clearOutputs();
 
      if (!plateNumber) {
        showError('×× × ×”×–×Ÿ ××¡×¤×¨ ×¨×™×©×•×™');
        return;
      }
 
      if (plateNumber.length < 7 || plateNumber.length > 8) {
        showError('××¡×¤×¨ ×¨×™×©×•×™ ×¦×¨×™×š ×œ×”×›×™×œ 7-8 ×¡×¤×¨×•×ª');
        return;
      }
 
      document.getElementById('loading').innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>××—×¤×© ×‘×××’×¨ data.gov.il...</p>
        </div>
      `;
      document.getElementById('loading').style.display = 'block';
 
      try {
        const response = await fetch(`${SERVER_URL}/api/vehicle/${plateNumber}`);
        const result = await response.json();
 
        document.getElementById('loading').style.display = 'none';
 
        if (result.success && result.data) {
          displayResults(result.data);
          showStatus(`× ××¦× ×¨×›×‘ ×¢×‘×•×¨: ${formatPlateNumber(plateNumber)}`, 'success');
          return;
        }
 
        // ×œ× × ××¦×: ×××¤×©×¨ â€œ××•×¢××“ ×”×‘×â€ ×× ×™×©
        showError(result.message || '×œ× × ××¦××• × ×ª×•× ×™× ×¢×‘×•×¨ ××¡×¤×¨ ×¨×™×©×•×™ ×–×”');
 
        if (ocrCandidates.length > 1 && currentCandidateIndex < ocrCandidates.length - 1) {
          showStatus(
            `×œ× × ××¦× ×¢×‘×•×¨ ${formatPlateNumber(plateNumber)}. ×œ×—×¥ "× ×¡×” ××•×¢××“ ×”×‘×".`,
            'info'
          );
          setTryNextEnabled();
        } else if (ocrCandidates.length > 1) {
          showStatus('× ×™×¡×™×ª ××ª ×›×œ ×”××•×¢××“×™×. × ×¡×” ×ª××•× ×” ×˜×•×‘×” ×™×•×ª×¨ ××• ×”×§×œ×“ ×™×“× ×™×ª.', 'info');
          setTryNextEnabled();
        }
      } catch (error) {
        document.getElementById('loading').style.display = 'none';
        showError(`×©×’×™××ª ×—×™×‘×•×¨ ×œ×©×¨×ª: ${error.message}<br><br>×•×•×“× ×©-:<br>1. ×”×©×¨×ª ×¨×¥<br>2. ×›×ª×•×‘×ª ×”×©×¨×ª × ×›×•× ×” ×œ××¢×œ×”`);
      }
    }
 
    function formatPlateNumber(plate) {
      if (plate.length === 7) {
        return `${plate.substring(0, 2)}-${plate.substring(2, 5)}-${plate.substring(5)}`;
      } else if (plate.length === 8) {
        return `${plate.substring(0, 3)}-${plate.substring(3, 5)}-${plate.substring(5)}`;
      }
      return plate;
    }
 
    function displayResults(vehicle) {
      const fields = {
        'mispar_rechev': 'ğŸ”¢ ××¡×¤×¨ ×¨×›×‘',
        'tozeret_nm': 'ğŸ­ ×ª×•×¦×¨×ª (×™×¦×¨×Ÿ)',
        'cinuy_mishari': 'ğŸš— ×›×™× ×•×™ ××¡×—×¨×™',
        'degem_nm': '×©× ×“×’×',
        'ramat_gimur': 'â­ ×¨××ª ×’×™××•×¨',
        'shnat_yitzur': 'ğŸ“… ×©× ×ª ×™×™×¦×•×¨',
        'tzeva_rechev': 'ğŸ¨ ×¦×‘×¢ ×¨×›×‘',
        'kvutzat_zihum': 'ğŸŒ± ×§×‘×•×¦×ª ×–×™×”×•×',
        'sug_delek_nm': 'â›½ ×¡×•×’ ×“×œ×§',
        'misgeret': 'ğŸ”‘ ××¡×¤×¨ ×©×œ×“×”',
        'mishkal_kolel': 'âš–ï¸ ××©×§×œ ×›×•×œ×œ',
        'nefach_manoa': 'ğŸ“Š × ×¤×— ×× ×•×¢',
        'koach_sus': 'ğŸ’ª ×›×•×— ×¡×•×¡'
      };
 
      let html = '<div class="results"><h3>âœ… × ×ª×•× ×™× ××××’×¨ data.gov.il</h3>';
 
      let count = 0;
      for (const [key, label] of Object.entries(fields)) {
        if (vehicle[key] && vehicle[key] !== '' && vehicle[key] !== 'null') {
          count++;
          html += `
            <div class="result-item">
              <span class="result-label">${label}</span>
              <span class="result-value">${vehicle[key]}</span>
            </div>
          `;
        }
      }
 
      if (count === 0) {
        html += '<p style="text-align: center; color: #666; padding: 20px;">×”×¨×›×‘ × ××¦× ××š ××™×Ÿ ××™×“×¢ × ×•×¡×£ ×–××™×Ÿ</p>';
      }
 
      html += '</div>';
      document.getElementById('results').innerHTML = html;
      document.getElementById('results').style.display = 'block';
    }
 
    function showError(message) {
      document.getElementById('error').innerHTML = `
        <div class="error">
          <strong>âš ï¸ ×©×’×™××”</strong><br>
          ${message}
        </div>
      `;
      document.getElementById('error').style.display = 'block';
    }
 
    document.getElementById('plateInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') searchVehicle();
    });
 
    document.getElementById('plateInput').addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/\D/g, '');
    });
  </script>
</body>
</html>
 
